/**
 * File		: EditUserCryptedDir.ycp
 * Module	: Users configurator
 * Summary	: Test of Users::EditUser function
 * Author	: Jiri Suchomel <jsuchome@suse.cz>
 *
 * $Id$
 */

{
    // testedfiles: Users.pm UsersPasswd.pm UsersLDAP.pm UsersRoutines.pm

    import "Directory";
    import "Mode";
    import "Users";
    import "UsersPasswd";
    import "UsersRoutines";

    string tmpdir	= Directory::tmpdir;
    foreach (string file, [ "passwd", "group", "shadow" ], {
	string cmd	= sformat ("/bin/cp ./%1 %2/", file, tmpdir);
	SCR::Execute (.target.bash_output, cmd);
    });
    Users::SetBaseDirectory (tmpdir);
    Users::ReadLocal ();

    map READ = $[
	"etc" : $[
	    "fstab": [],
	    "cryptotab": [],
	    "default": $[
		"useradd": $[
		    "home":	"/home",
		    "groups":	"audio,video",
		    "group":	100
		]
	    ],
	],
	"target": $[
	    "stat"	: $[],
	    "size"	: -1,
	    "tmpdir"	: "/tmp/YaST"
	],
	"product": $[
		"features": $[
		    "USE_DESKTOP_SCHEDULER"	: "no",
		    "IO_SCHEDULER"		: "",
		    "ENABLE_AUTOLOGIN"		: "false",
		    "UI_MODE"			: "simple",
		    "EVMS_CONFIG"		: "no",
		    "INCOMPLETE_TRANSLATION_TRESHOLD"	: "99",
		]
	],
	"anyxml"	: $[
	    "pam_mount"	: [
		$[
		    "volume":	[
			$[
			    "user"	: "not-hh",
			    "path"	: "/home/hh.img",
			    "fskeypath"	: "/home/hh.key"
			]
		    ]
		]
	    ]
	]
    ];
    map WRITE = $[];
    map EXEC = $[
	"passwd" : $[
	    "init"	: true
	],
	"target" : $[
	    "bash"		: 0,
	    "bash_output"	: $[
		"exit"		: 0,
	    ],
	],
    ];
    map RW	= $[
	"target": $[
	    // this is wrong. key_file and img_file from CryptHome should _not_ exist, but cryptconfig binary has to
	    "stat"	: $[ "a" : "b"],
	    "size"	: -1,
	    "tmpdir"	: "/tmp/YaST"
	],
    ];

    import "Testsuite";

    Testsuite::Dump ("==========================================================");

    Mode::SetTest ("test");

    Testsuite::Test (``(Users::Read ()), [READ, WRITE, EXEC], 0);

    // for home directory checks
    READ["target","stat","isdir"]	= true;

    Testsuite::Test (``(Users::SelectUserByName ("hh")), [], 0);

    map<string,any> changes = $[
	"crypted_home_size"		: 100,
	"current_text_userpassword"	: "password" // needed for cryptconfig
    ];


    Testsuite::Test (``(Users::EditUser (changes)), [READ, WRITE, EXEC], 0);

    Testsuite::Dump (sformat ("---- user 'hh':\n %1", Users::GetCurrentUser ()));

    Testsuite::Test (``(Users::CommitUser ()), [READ, WRITE, EXEC], 0);

    Testsuite::Test (``(Users::SetBaseDirectory ("/etc")), [], 0);
    Testsuite::Test (``(UsersPasswd::SetBaseDirectory ("/etc")), [], 0);

    Testsuite::Test (``(Directory::ResetTmpDir ()), [RW, WRITE, EXEC], 0);

    // this incorrectly calles 'cryptconfig enlarge-image' instead of
    // 'cryptconfig make-ehd' because of the mess in FileUtils->Exists
    Testsuite::Test (``(Users::Write ()), [RW, WRITE, EXEC], 0);
}
